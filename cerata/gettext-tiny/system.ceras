# Copyright (c) 2019-2020, Firas Khalil Khana
# Distributed under the terms of the ISC License

# Voyager: Firas Khalil Khana (firasuke) <firasuke@glaucuslinux.org>

prepare_system() {
  $RSYNC $SRCD/$nom/$nom-$ver/ $SSRC/$nom --delete &&
  cd $SSRC/$nom &&

  $SCRD/patch 1 $nom sabotage 0001-Revert-libintl.h-don-t-enable-NOP-macros-by-default.patch &&
  $SCRD/patch 1 $nom sabotage 0002-autopoint-add-sanity-check-for-configure.ac.patch &&
  $SCRD/patch 1 $nom sabotage 0003-Revert-msgfmt-remove-unused-error-function.patch &&
  $SCRD/patch 1 $nom sabotage 0004-stringescape-correct-break-condition-of-unescape.patch &&
  $SCRD/patch 1 $nom sabotage 0005-complete-rewrite-of-poparser-msgmerge-msgfmt-ported.patch &&
  $SCRD/patch 1 $nom sabotage 0006-msgmerge-use-the-same-size-as-msgfmt.patch &&
  $SCRD/patch 1 $nom sabotage 0007-stringescape-add-missing-escape-chars-to-escape.patch &&
  $SCRD/patch 1 $nom sabotage 0008-msgmerge-give-enough-space-for-escape.patch &&
  $SCRD/patch 1 $nom sabotage 0009-poparser-not-to-skip-sysdeps-other-than-PRIu32.patch &&
  $SCRD/patch 1 $nom sabotage 0010-msgmerge-pretty-the-output-with-breaklines.patch &&
  $SCRD/patch 1 $nom sabotage 0011-poparser-avoid-invalid-memory-access.patch &&
  $SCRD/patch 1 $nom sabotage 0012-poparser-optimize-by-saving-strlen-results.patch &&
  $SCRD/patch 1 $nom sabotage 0013-poparpser-avoid-endless-loop.patch &&
  $SCRD/patch 1 $nom sabotage 0014-msgfmt-skip-impossible-cases.patch &&
  $SCRD/patch 1 $nom sabotage 0015-poparser-a-more-easy-to-understand-sysdep.patch &&
  $SCRD/patch 1 $nom sabotage 0016-poparser-simplified-sysdep-more.patch &&
  $SCRD/patch 1 $nom sabotage 0017-msgfmt-add-missing-operator.patch &&
  $SCRD/patch 1 $nom sabotage 0018-msgfmt-add-missing-messages-count-variable.patch &&
  $SCRD/patch 1 $nom sabotage 0019-msgfmt-poparser-correct-length-at-str-table.patch &&
  $SCRD/patch 1 $nom sabotage 0020-poparser-avoid-invalid-memory-access.patch &&
  $SCRD/patch 1 $nom sabotage 0021-poparser-avoid-memory-corruption-by-terminator.patch &&
  $SCRD/patch 1 $nom sabotage 0022-poparser-avoid-comparisons-of-different-signs.patch &&
  $SCRD/patch 1 $nom sabotage 0023-poparser-return-if-the-buf-is-too-small.patch &&
  $SCRD/patch 1 $nom sabotage 0024-poparser-set-correct-length-after-parsing-codecs.patch &&
  $SCRD/patch 1 $nom sabotage 0025-poparser-convert-codecs-at-both-two-stages.patch &&
  $SCRD/patch 1 $nom sabotage 0026-poparser-avoid-32-bit-truncation-by-unsigned.patch &&
  $SCRD/patch 1 $nom sabotage 0027-msgfmt-do-not-return-the-result-of-remove.patch &&
  $SCRD/patch 1 $nom sabotage 0028-poparser-enable-first-flag-at-both-two-stages.patch &&
  $SCRD/patch 1 $nom sabotage 0029-poparser-disable-first-flag-after-a-msgblock.patch &&
  $SCRD/patch 1 $nom sabotage 0030-poparser-should-check-length-instead-of-pointer.patch &&
  $SCRD/patch 1 $nom sabotage 0031-poparser-clean-msg-comment-flags.patch &&
  $SCRD/patch 1 $nom sabotage 0032-poparser-comment-may-start-a-new-block-too.patch &&
  $SCRD/patch 1 $nom sabotage 0033-poparser-add-po_error_last-to-po_error-type.patch &&
  $SCRD/patch 1 $nom sabotage 0034-poparser-convert-codecs-at-both-two-stages.patch &&
  $SCRD/patch 1 $nom sabotage 0035-poparser-charset-str-should-stop-at-escape-chars.patch &&
  $SCRD/patch 1 $nom sabotage 0036-poparser-default-to-non-strict-mode.patch &&
  $SCRD/patch 1 $nom sabotage 0037-msgfmt-enable-strict-mode-with-c-argument.patch &&
  $SCRD/patch 1 $nom sabotage 0038-poparser-msgid_plural-is-with-nplurals-2.patch &&
  $SCRD/patch 1 $nom sabotage 0039-poparser-not-check-overflow-for-msgid_plural.patch &&
  $SCRD/patch 1 $nom sabotage 0040-msgfmt-clean-code-prepare-to-handle-other-modes.patch &&
  $SCRD/patch 1 $nom sabotage 0041-msgfmt-missing-break.patch &&
  $SCRD/patch 1 $nom sabotage 0042-xgettext-parse-arguments-correctly.patch &&
  $SCRD/patch 1 $nom sabotage 0043-gettext-tiny-Fix-format-not-a-string-literal-error-4.patch &&
  $SCRD/patch 1 $nom sabotage 0044-autopoint-support-dist-target-to-release-tarballs.patch &&
  $SCRD/patch 1 $nom sabotage 0045-data-Makefile.in-add-missing-maintainer-targets.patch &&
  $SCRD/patch 1 $nom sabotage 0046-msgfmt-support-keyword-template-output-options.patch &&
  $SCRD/patch 1 $nom sabotage 0047-Makefile-fix-install-failure-if-path-contains-m4-str.patch &&
  $SCRD/patch 1 $nom sabotage 0048-msgmerge-avoid-printing-too-long-line.patch
}

configure_system() {
  printf "prefix=/usr
LIBINTL=MUSL
AR=$AR
RANLIB=$RANLIB
CFLAGS=$CFLAGS -fPIC
LDFLAGS=$LDFLAGS\n" > config.mak
}

build_system() {
  make
}

install_system() {
  make \
    DESTDIR=$SCER/$nom/sac \
    install &&

  $RSYNC $CERD/$nom/autopoint $SCER/$nom/sac/usr/bin/autopoint
}
