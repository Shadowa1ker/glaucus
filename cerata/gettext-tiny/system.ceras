# Copyright (c) 2019-2020, Firas Khalil Khana
# Distributed under the terms of the ISC License

# Voyager: Firas Khalil Khana (firasuke) <firasuke@glaucuslinux.org>

prepare_system() {
  $RSYNC $SRCD/$nom/$nom-$ver/ $SSRC/$nom --delete &&
  cd $SSRC/$nom &&

  $SCRD/patch 1 $nom sabotage 0001-Revert-libintl.h-don-t-enable-NOP-macros-by-default &&
  $SCRD/patch 1 $nom sabotage 0002-autopoint-add-sanity-check-for-configure.ac &&
  $SCRD/patch 1 $nom sabotage 0003-Revert-msgfmt-remove-unused-error-function &&
  $SCRD/patch 1 $nom sabotage 0004-stringescape-correct-break-condition-of-unescape &&
  $SCRD/patch 1 $nom sabotage 0005-complete-rewrite-of-poparser-msgmerge-msgfmt-ported &&
  $SCRD/patch 1 $nom sabotage 0006-msgmerge-use-the-same-size-as-msgfmt &&
  $SCRD/patch 1 $nom sabotage 0007-stringescape-add-missing-escape-chars-to-escape &&
  $SCRD/patch 1 $nom sabotage 0008-msgmerge-give-enough-space-for-escape &&
  $SCRD/patch 1 $nom sabotage 0009-poparser-not-to-skip-sysdeps-other-than-PRIu32 &&
  $SCRD/patch 1 $nom sabotage 0010-msgmerge-pretty-the-output-with-breaklines &&
  $SCRD/patch 1 $nom sabotage 0011-poparser-avoid-invalid-memory-access &&
  $SCRD/patch 1 $nom sabotage 0012-poparser-optimize-by-saving-strlen-results &&
  $SCRD/patch 1 $nom sabotage 0013-poparpser-avoid-endless-loop &&
  $SCRD/patch 1 $nom sabotage 0014-msgfmt-skip-impossible-cases &&
  $SCRD/patch 1 $nom sabotage 0015-poparser-a-more-easy-to-understand-sysdep &&
  $SCRD/patch 1 $nom sabotage 0016-poparser-simplified-sysdep-more &&
  $SCRD/patch 1 $nom sabotage 0017-msgfmt-add-missing-operator &&
  $SCRD/patch 1 $nom sabotage 0018-msgfmt-add-missing-messages-count-variable &&
  $SCRD/patch 1 $nom sabotage 0019-msgfmt-poparser-correct-length-at-str-table &&
  $SCRD/patch 1 $nom sabotage 0020-poparser-avoid-invalid-memory-access &&
  $SCRD/patch 1 $nom sabotage 0021-poparser-avoid-memory-corruption-by-terminator &&
  $SCRD/patch 1 $nom sabotage 0022-poparser-avoid-comparisons-of-different-signs &&
  $SCRD/patch 1 $nom sabotage 0023-poparser-return-if-the-buf-is-too-small &&
  $SCRD/patch 1 $nom sabotage 0024-poparser-set-correct-length-after-parsing-codecs &&
  $SCRD/patch 1 $nom sabotage 0025-poparser-convert-codecs-at-both-two-stages &&
  $SCRD/patch 1 $nom sabotage 0026-poparser-avoid-32-bit-truncation-by-unsigned &&
  $SCRD/patch 1 $nom sabotage 0027-msgfmt-do-not-return-the-result-of-remove &&
  $SCRD/patch 1 $nom sabotage 0028-poparser-enable-first-flag-at-both-two-stages &&
  $SCRD/patch 1 $nom sabotage 0029-poparser-disable-first-flag-after-a-msgblock &&
  $SCRD/patch 1 $nom sabotage 0030-poparser-should-check-length-instead-of-pointer &&
  $SCRD/patch 1 $nom sabotage 0031-poparser-clean-msg-comment-flags &&
  $SCRD/patch 1 $nom sabotage 0032-poparser-comment-may-start-a-new-block-too &&
  $SCRD/patch 1 $nom sabotage 0033-poparser-add-po_error_last-to-po_error-type &&
  $SCRD/patch 1 $nom sabotage 0034-poparser-convert-codecs-at-both-two-stages &&
  $SCRD/patch 1 $nom sabotage 0035-poparser-charset-str-should-stop-at-escape-chars &&
  $SCRD/patch 1 $nom sabotage 0036-poparser-default-to-non-strict-mode &&
  $SCRD/patch 1 $nom sabotage 0037-msgfmt-enable-strict-mode-with-c-argument &&
  $SCRD/patch 1 $nom sabotage 0038-poparser-msgid_plural-is-with-nplurals-2 &&
  $SCRD/patch 1 $nom sabotage 0039-poparser-not-check-overflow-for-msgid_plural &&
  $SCRD/patch 1 $nom sabotage 0040-msgfmt-clean-code-prepare-to-handle-other-modes &&
  $SCRD/patch 1 $nom sabotage 0041-msgfmt-missing-break &&
  $SCRD/patch 1 $nom sabotage 0042-xgettext-parse-arguments-correctly &&
  $SCRD/patch 1 $nom sabotage 0043-$nom-Fix-format-not-a-string-literal-error-4 &&
  $SCRD/patch 1 $nom sabotage 0044-autopoint-support-dist-target-to-release-tarballs &&
  $SCRD/patch 1 $nom sabotage 0045-data-Makefile.in-add-missing-maintainer-targets &&
  $SCRD/patch 1 $nom sabotage 0046-msgfmt-support-keyword-template-output-options &&
  $SCRD/patch 1 $nom sabotage 0047-Makefile-fix-install-failure-if-path-contains-m4-str &&
  $SCRD/patch 1 $nom sabotage 0048-msgmerge-avoid-printing-too-long-line
}

configure_system() {
  printf "prefix=/usr
LIBINTL=MUSL
AR=$AR
RANLIB=$RANLIB
CFLAGS=$CFLAGS -fPIC
LDFLAGS=$LDFLAGS\n" > config.mak
}

build_system() {
  make
}

install_system() {
  make \
    DESTDIR=$SCER/$nom/sac \
    install &&

  $RSYNC $CERD/$nom/autopoint $SCER/$nom/sac/usr/bin/autopoint &&
  chown 0:0 $SCER/$nom/sac/usr/bin/autopoint
}
